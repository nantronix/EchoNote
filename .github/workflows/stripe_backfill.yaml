on:
  workflow_dispatch:
    inputs:
      created_gte:
        description: "Only sync objects created at or after this unix timestamp (optional)"
        required: false
        type: string
      created_lte:
        description: "Only sync objects created at or before this unix timestamp (optional)"
        required: false
        type: string

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/bun_install
      - uses: ./.github/actions/pnpm_install
      - uses: ./.github/actions/infisical_install
      - run: pnpm --filter @echonote/api install
      - run: |
          ARGS=""
          if [ -n "${{ inputs.created_gte }}" ]; then
            ARGS="$ARGS --created-gte ${{ inputs.created_gte }}"
          fi
          if [ -n "${{ inputs.created_lte }}" ]; then
            ARGS="$ARGS --created-lte ${{ inputs.created_lte }}"
          fi
          infisical run --token="$INFISICAL_TOKEN" --env=prod --projectId="$INFISICAL_PROJECT_ID" --path="/stripe-backfill" -- bun apps/api/src/scripts/stripe-backfill.ts $ARGS
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
